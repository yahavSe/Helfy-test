{
  "uid": "helfy-cdc",
  "title": "Helfy CDC - Logs & Ops",
  "tags": ["helfy", "cdc", "tidb", "kafka"],
  "timezone": "browser",
  "schemaVersion": 40,
  "version": 1,
  "refresh": "10s",
  "time": { "from": "now-1h", "to": "now" },
  "panels": [
    {
      "id": 1,
      "type": "piechart",
      "title": "Last 1h operations by type (insert/update/delete)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "x": 0, "y": 0, "w": 12, "h": 9 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(increase(cdc_events_total[$__range])) by (op)",
          "legendFormat": "{{op}}",
          "instant": true
        }
      ],
      "options": {
        "legend": { "displayMode": "list", "placement": "right", "showLegend": true },
        "pieType": "pie",
        "reduceOptions": { "calcs": ["lastNotNull"], "values": false },
        "tooltip": { "mode": "single" },
        "displayLabels": ["name", "value", "percent"]
      },
      "fieldConfig": { "defaults": { "unit": "short", "min": 0 }, "overrides": [] }
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "CDC events rate (by op)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "x": 12, "y": 0, "w": 12, "h": 9 },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(rate(cdc_events_total[1m])) by (op)",
          "legendFormat": "{{op}}"
        }
      ],
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
        "tooltip": { "mode": "single" }
      },
      "fieldConfig": { "defaults": { "unit": "ops", "min": 0 }, "overrides": [] }
    },
    {
      "id": 3,
      "type": "table",
      "title": "Raw CDC events (from Elasticsearch)",
      "datasource": { "type": "elasticsearch", "uid": "elasticsearch" },
      "gridPos": { "x": 0, "y": 9, "w": 24, "h": 12 },
      "targets": [
        {
          "refId": "A",
          "query": "msg:\"cdc_event\" OR message:\"cdc_event\"",
          "timeField": "@timestamp",
          "metrics": [
            {
              "id": "1",
              "type": "raw_document",
              "settings": { "size": "50" }
            }
          ],
          "bucketAggs": [
            {
              "id": "2",
              "type": "date_histogram",
              "field": "@timestamp",
              "settings": { "interval": "auto" }
            }
          ]
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": {
              "log.file.path": true,
              "container.labels": true,
              "ecs.version": true,
              "agent.ephemeral_id": true,
              "agent.id": true
            },
            "indexByName": {
              "@timestamp": 0,
              "container.name": 1,
              "table": 2,
              "op": 3,
              "msg": 4,
              "message": 5
            },
            "renameByName": {
              "@timestamp": "time",
              "container.name": "container"
            }
          }
        }
      ],
      "options": {
        "showHeader": true,
        "sortBy": [{ "displayName": "time", "desc": true }]
      }
    }
  ]
}
